name: Manual Build bsp_builder Binaries

on:
  workflow_dispatch: # Allows manual triggering from the Actions tab

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: ./bsp_builder
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: manylinux_x86_64
          - os: windows-latest
            platform: win_amd64
          - os: macos-latest
            platform: universal2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pybind11

      - name: Configure CMake
        run: >
          cmake -S . -B build
          -DCMAKE_BUILD_TYPE=Release
          -DPYTHON_EXECUTABLE=${{ env.pythonLocation }}/python
          ${{ matrix.os == 'macos-latest' && '-DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"' || '' }}

      - name: Build
        run: cmake --build build --config Release

      - name: Rename and Prepare Binary
        shell: bash
        run: |
          # Get the platform-specific extension suffix from Python
          SUFFIX=$(python3 -c "import sysconfig; print(sysconfig.get_config_var('EXT_SUFFIX'))")
          
          # Find the binary inside the subdirectory's build folder
          RAW_FILE=$(find build -name "*.so" -o -name "*.pyd" | head -n 1)
          
          echo "Found raw binary: $RAW_FILE"
          echo "Target suffix: $SUFFIX"
          
          # Create an output folder inside the subdirectory
          mkdir -p final_dist
          cp "$RAW_FILE" "final_dist/bsp_builder$SUFFIX"

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: bsp_builder-${{ matrix.platform }}
          # Path is relative to the repository root, so we include the subdirectory
          path: bsp_builder/final_dist/
